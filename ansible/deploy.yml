---
- name: Deploy Laravel Application
  hosts: all
  become: yes

  vars:
    git_repo: https://github.com/MADUSHADEV/Jenkins-pipeline-laravel.git
    git_branch: main
    app_user: www-data
    php_version: "8.3"

  tasks:
    #------------------------------------------
    # Step 1: Prepare Project Directory
    #------------------------------------------
    - name: Ensure project root directory exists
      ansible.builtin.file:
        path: "{{ project_root }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0755"

    #------------------------------------------
    # Step 2: Clone/Update Repository
    #------------------------------------------
    - name: Clone or update the project repository
      ansible.builtin.git:
        repo: "{{ git_repo }}"
        dest: "{{ project_root }}"
        version: "{{ git_branch }}"
        force: yes
      become_user: "{{ app_user }}"

    #------------------------------------------
    # Step 3: Install Composer Dependencies
    #------------------------------------------
    - name: Install Composer dependencies
      community.general.composer:
        command: install
        working_dir: "{{ project_root }}"
        prefer_dist: yes
        no_dev: yes
        optimize_autoloader: yes
      become_user: "{{ app_user }}"
      environment:
        COMPOSER_ALLOW_SUPERUSER: "1"

    #------------------------------------------
    # Step 4: Set Up Environment Configuration
    #------------------------------------------
    - name: Create .env file from template
      ansible.builtin.template:
        src: .env.j2
        dest: "{{ project_root }}/.env"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0644"

    - name: Check if APP_KEY is set
      ansible.builtin.shell: grep -q "APP_KEY=base64:" {{ project_root }}/.env
      register: app_key_check
      failed_when: false
      changed_when: false

    - name: Generate Laravel application key if not set
      ansible.builtin.command:
        cmd: php artisan key:generate --force
        chdir: "{{ project_root }}"
      become_user: "{{ app_user }}"
      when: app_key_check.rc != 0

    #------------------------------------------
    # Step 5: Install NPM Dependencies and Build Assets
    #------------------------------------------
    - name: Clear existing node_modules
      ansible.builtin.file:
        path: "{{ project_root }}/node_modules"
        state: absent
      become_user: "{{ app_user }}"

    - name: Fix npm cache permissions
      ansible.builtin.file:
        path: "/var/www/.npm"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0755"
        recurse: yes

    - name: Clean npm cache
      ansible.builtin.command:
        cmd: npm cache clean --force
      become_user: "{{ app_user }}"
      environment:
        HOME: "/var/www"

    - name: Install npm dependencies
      community.general.npm:
        path: "{{ project_root }}"
        state: present
      become_user: "{{ app_user }}"

    - name: Build frontend assets with npm
      ansible.builtin.command:
        cmd: npm run build
        chdir: "{{ project_root }}"
      become_user: "{{ app_user }}"
      environment:
        NODE_ENV: production

    #------------------------------------------
    # Step 6: Run Database Migrations
    #------------------------------------------
    - name: Run Laravel migrations
      ansible.builtin.command:
        cmd: php artisan migrate --force
        chdir: "{{ project_root }}"
      become_user: "{{ app_user }}"
      register: migration_result
      failed_when: false

    - name: Display migration result
      ansible.builtin.debug:
        msg: "{{ migration_result.stdout_lines }}"
      when: migration_result.stdout_lines is defined

    #------------------------------------------
    # Step 7: Clear Laravel Caches
    #------------------------------------------
    - name: Clear Laravel caches
      ansible.builtin.shell: |
        php artisan config:clear
        php artisan cache:clear
        php artisan route:clear
        php artisan view:clear
      args:
        chdir: "{{ project_root }}"
      become_user: "{{ app_user }}"

    #------------------------------------------
    # Step 8: Optimize Laravel for Production
    #------------------------------------------
    - name: Cache Laravel configurations
      ansible.builtin.shell: |
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache
      args:
        chdir: "{{ project_root }}"
      become_user: "{{ app_user }}"

    #------------------------------------------
    # Step 9: Set Correct Permissions
    #------------------------------------------
    - name: Set ownership for all application files
      ansible.builtin.file:
        path: "{{ project_root }}"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        recurse: yes

    - name: Set correct permissions for storage directory
      ansible.builtin.file:
        path: "{{ project_root }}/storage"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0775"
        recurse: yes

    - name: Set correct permissions for bootstrap/cache
      ansible.builtin.file:
        path: "{{ project_root }}/bootstrap/cache"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0775"
        recurse: yes

    #------------------------------------------
    # Step 10: Configure Nginx
    #------------------------------------------
    - name: Deploy Nginx configuration
      ansible.builtin.template:
        src: nginx.conf.j2
        dest: /etc/nginx/sites-available/bislinker-{{ app_env }}.conf
        owner: root
        group: root
        mode: "0644"
      notify: Reload Nginx

    - name: Enable Nginx site
      ansible.builtin.file:
        src: /etc/nginx/sites-available/bislinker-{{ app_env }}.conf
        dest: /etc/nginx/sites-enabled/bislinker-{{ app_env }}.conf
        state: link
      notify: Reload Nginx

    - name: Remove default Nginx site if exists
      ansible.builtin.file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: Reload Nginx

    - name: Test Nginx configuration
      ansible.builtin.command: nginx -t
      register: nginx_test
      changed_when: false

    - name: Display Nginx test result
      ansible.builtin.debug:
        msg: "{{ nginx_test.stderr_lines }}"

    #------------------------------------------
    # Step 11: Restart PHP-FPM
    #------------------------------------------
    - name: Restart PHP-FPM service
      ansible.builtin.systemd:
        name: "php{{ php_version }}-fpm"
        state: restarted

    #------------------------------------------
    # Step 12: Setup Queue Worker (Optional - via Supervisor)
    #------------------------------------------
    - name: Create Supervisor configuration for Laravel queue
      ansible.builtin.template:
        src: laravel-worker.conf.j2
        dest: /etc/supervisor/conf.d/laravel-worker.conf
        owner: root
        group: root
        mode: "0644"
      notify: Restart Supervisor
      when: enable_queue_worker | default(false)

    #------------------------------------------
    # Final Summary
    #------------------------------------------
    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Deployment Complete!"
          - "=========================================="
          - "Environment: {{ app_env }}"
          - "Project: {{ project_root }}"
          - "Branch: {{ git_branch }}"
          - "=========================================="

  # ----------------------------------------------------------------
  # HANDLERS
  # ----------------------------------------------------------------
  handlers:
    - name: Reload Nginx
      ansible.builtin.systemd:
        name: nginx
        state: reloaded

    - name: Restart Supervisor
      ansible.builtin.systemd:
        name: supervisor
        state: restarted
