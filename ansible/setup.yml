---
- name: Prepare Servers for Host-Based Laravel Deployment for Production and Staging
  hosts: all # This tells Ansible to run these tasks on ALL hosts in the inventory
  become: yes # This tells Ansible to run the tasks using sudo (become super-user)
  vars:
    php_version: "8.3" # Define the PHP version to be used
    node_version: "20" # Define the Node.js version to be used
  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600
      changed_when: false # Don't report this step as changed

    - name: Install system dependencies
      ansible.builtin.apt:
        name:
          - software-properties-common
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - git
          - unzip
          - supervisor
          - ufw
          - acl
        state: present # Ensure these packages are installed

    # ==========================================
    # Install PHP 8.3 PHP PPA repository and Extensions
    # ==========================================
    - name: Add Ondrej PHP GPG key
      ansible.builtin.get_url:
        url: https://packages.sury.org/php/apt.gpg
        dest: /etc/apt/trusted.gpg.d/php.gpg
        mode: "0644"
        force: true

    - name: Add Ondrej PHP repository
      ansible.builtin.apt_repository:
        repo: "deb https://packages.sury.org/php/ {{ ansible_distribution_release }} main"
        state: present

    - name: Install PHP 8.3 and extensions
      ansible.builtin.apt:
        name:
          - "php{{ php_version }}-fpm"
          - "php{{ php_version }}-cli"
          - "php{{ php_version }}-common"
          - "php{{ php_version }}-pgsql"
          - "php{{ php_version }}-mysql"
          - "php{{ php_version }}-bcmath"
          - "php{{ php_version }}-xml"
          - "php{{ php_version }}-curl"
          - "php{{ php_version }}-zip"
          - "php{{ php_version }}-mbstring"
          - "php{{ php_version }}-redis"
          - "php{{ php_version }}-gd"
          - "php{{ php_version }}-intl"
          - "php{{ php_version }}-opcache"
        state: present

    - name: Ensure PHP-FPM is started and enabled
      ansible.builtin.service:
        name: "php{{ php_version }}-fpm"
        state: started
        enabled: yes

    # ==========================================
    # Install Nginx
    # ==========================================
    - name: Install Nginx
      ansible.builtin.apt:
        name: nginx
        state: present

    - name: Ensure Nginx is started and enabled
      ansible.builtin.service:
        name: nginx
        state: started
        enabled: yes

    # ==========================================
    # Install Composer
    # ==========================================
    - name: Download Composer installer
      ansible.builtin.get_url:
        url: https://getcomposer.org/installer
        dest: /tmp/composer-setup.php
        mode: "0755"

    - name: Install Composer
      ansible.builtin.command:
        cmd: php /tmp/composer-setup.php --install-dir=/usr/local/bin --filename=composer
      args:
        creates: /usr/local/bin/composer

    - name: Remove Composer setup file
      ansible.builtin.file:
        path: /tmp/composer-setup.php
        state: absent

    # ==========================================
    # Install Node.js 20.x
    # ==========================================
    - name: Remove old NodeSource GPG key if exists
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/apt/trusted.gpg.d/nodesource.gpg
        - /usr/share/keyrings/nodesource.gpg
      ignore_errors: yes

    - name: Remove old NodeSource repository files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/apt/sources.list.d/nodesource.list
        - /etc/apt/sources.list.d/nodesource.list.save
      ignore_errors: yes

    - name: Download NodeSource setup script
      ansible.builtin.get_url:
        url: https://deb.nodesource.com/setup_{{ node_version }}.x
        dest: /tmp/nodesource_setup.sh
        mode: "0755"

    - name: Run NodeSource setup script
      ansible.builtin.command:
        cmd: bash /tmp/nodesource_setup.sh
      args:
        creates: /etc/apt/sources.list.d/nodesource.list
      environment:
        DEBIAN_FRONTEND: noninteractive

    - name: Update apt cache after NodeSource setup
      ansible.builtin.apt:
        update_cache: yes

    - name: Install Node.js
      ansible.builtin.apt:
        name: nodejs
        state: present

    - name: Verify Node.js installation
      ansible.builtin.command: node --version
      register: nodejs_version_output
      changed_when: false

    - name: Display Node.js version
      ansible.builtin.debug:
        msg: "Node.js version installed: {{ nodejs_version_output.stdout }}"

    # ==========================================
    # Firewall Configuration (Optional)
    # ==========================================
    - name: Allow Nginx through firewall
      community.general.ufw:
        rule: allow
        name: "Nginx Full"
      when: ansible_facts['os_family'] == 'Debian'
      ignore_errors: yes # In case UFW is not installed

    # ==========================================
    # Final Summary
    # ==========================================
    - name: Display setup summary
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Server Setup Complete!"
          - "=========================================="
          - "PHP Version: 8.3"
          - "Node.js: {{ nodejs_version_output.stdout }}"
          - "Nginx: Installed"
          - "Composer: Installed"
          - "=========================================="
